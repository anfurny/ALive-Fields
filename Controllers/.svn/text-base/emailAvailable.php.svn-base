<?php
/** * EmailInterp Controller;
 * File: Controllers/EmailAvailable.php;
 * @copyright Copyright (c) 2008-2011, Language People, Inc.; All rights reserved.;
 * @author Alex Rohde;
 * ;
 * Created: April 25 2011; */


require_once("../includes/dispatch_functions.php"); 
require_once("../includes/alex_functions.php"); 

function emailInterpAppt($InterpID, $DispatchIDs)
{
	 database_connect();

	//security measure to make sure we don't send these out in
			//test environment
	$email_address = database_fetch_field("SELECT EMail from Interpreter WHERE InterpID = " . (int)$InterpID);
	$first = database_fetch_field("SELECT FirstName from Interpreter WHERE InterpID = " . (int)$InterpID);
	
	 if (detectEnvironment() != "live")
		$email_address = "languagepeople@mailmetrash.com"; 
												
			$strSubj = "Interpreter Request?";
			$the_body = "Hi " . $first . ", \nAre you free for ";
			
			if (count($DispatchIDs) > 1)
				$the_body .= "any of these appointments?\n\n";
			else
				$the_body .= "this appointment?\n\n";
				
			$x=0;
			foreach ($DispatchIDs as $d)
				{
				$DispRS = database_fetch_row(" SELECT  Convert(varchar(100), Dispatch.Scheduled, 100) as sked, Dispatch.SchedEnd, Dispatch.SpecialInstruction, Dispatch.Location as SpecLocation, Facility.Address as Facility, Facility.City as City, Facility.State as State, "
						. 	"Customer.CustomerName, Client.MedicalNo, Client.ClientFName, Client.ClientLName, Dispatch.ContactPerson FROM ((Dispatch LEFT JOIN Client ON Dispatch.ClientID = Client.ClientID) "  	.   "LEFT JOIN Customer ON Client.CustID = Customer.CustID) LEFT JOIN Facility ON Dispatch.FacilityID = Facility.FacilityID WHERE(Dispatch.FacilityID Is Not Null) And (Dispatch.DispatchID =  " . (int)$d . ")",0);
							
				$the_body .= (++$x) . ")\n" .
					 "Dispatch ID: " . $d . "\n" .
					 "Scheduled: " . $DispRS['sked'] .  "\n" .
					 "End Time: " .  date("h:i A", end(explode(" ", ($DispRS['SchedEnd'])))) .  "\n" .
					 "Address: " . trim($DispRS['Facility']) .  "\n" .
					 "City: " . trim($DispRS['City']) . ", " . trim($DispRS['State']);
				$the_body .= "\n\n"; 
				}	 
	//DoCmd.SendObject acSendNoObject, , , strBCC, , , strSubj, strMsg, True 
	//mail($email, $strSubj, $strMsg, "From: Dispatch@LanguagePeople.com");
	
	return ("mailto:" . $email_address . "?Subject=" . rawurlencode($strSubj) . "&body=" . rawurlencode($the_body ));		 
}

//var_dump($_GET);
echo emailInterpAppt((int)$_GET['InterpID'], explode(",", $_GET['DispatchIDs']) );



?>