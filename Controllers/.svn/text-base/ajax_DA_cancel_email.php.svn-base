<?PHP
require_once( "../models/ActionRecord.php");
require_once( "../includes/alex_functions.php");
require_once( "../includes/dispatch_functions.php");

//require_once("../Controllers/EmailInterp.php");

validate_logged_in();

function custom_error_handler($a,$b ="",$c ="",$d ="") { json_error($a . $b . $c . $d); return false;}

$DEBUG = false;
if ( ! $DEBUG)
	{
	 set_error_handler ("custom_error_handler", E_ERROR | E_PARSE | E_ALL);
	}
 else 
 	{
	error_reporting(E_ALL);		
 	echo "DEBUG IS ON";
	}
	
set_time_limit(10);
//$var = json_decode($_GET["request"], true);

database_connect();
$tmp['response'] = cancel_mailto((int)$_GET['DispatchID'], (int)$_GET['InterpID'] );

echo json_encode($tmp);

/////////////////////////////////////////////////////////////////////////////

function cancel_mailto($DispatchID, $InterpID)
{ 
	$DispRS = database_query("SELECT Dispatch.DispatchID, Dispatch.Scheduled, Customer.CustomerName, Facility.Address AS Facility, Facility.City AS City, Facility.State FROM (( Dispatch LEFT OUTER JOIN Client ON Dispatch.ClientID = Client.ClientID) LEFT OUTER JOIN Customer ON Client.CustID = Customer.CustID) LEFT OUTER JOIN Facility ON Dispatch.FacilityID = Facility.FacilityID WHERE (Dispatch.FacilityID IS NOT NULL) AND (Dispatch.DispatchID = $DispatchID) 
							UNION SELECT Dispatch.DispatchID, Dispatch.Scheduled, Customer.CustomerName,CAST( Dispatch.Location as varchar) as Facility, CAST(ZIPCodes.CityName as varchar) AS City, CAST(ZIPCodes.StateAbbr as varchar)AS State FROM ((( Dispatch  LEFT OUTER JOIN Client ON Dispatch.ClientID = Client.ClientID) INNER JOIN Customer ON Client.CustID = Customer.CustID) INNER JOIN ZIPCodes ON (Dispatch.Longitude = ZIPCodes.Longitude) AND (Dispatch.Latitude = ZIPCodes.Latitude)) WHERE (Dispatch.DispatchID = $DispatchID) ", 0);
//,
    $strBCC = database_fetch_field("SELECT CAST(Interpreter.Email as varchar) as EMail FROM Interpreter WHERE InterpID= $InterpID",1);
	//echo "K";
    if (mssql_num_rows($DispRS) ) 
		{
		$row = mssql_fetch_assoc($DispRS);
		
        if (!strlen($strBCC) )
			{//MsgBox "Cannot Email Interpreter about Cancelation. No Email address", vbInformation, "Process Abandoned"
//			echo "NULL!";
			return false; //Exit Sub
			}
     	   
     	 $strSubj = "Your LP appointment at " . date("m-d-y h:i", strtotime($row['Scheduled'])) . " has been canceled";
        
     	 $strMsg = "***CANCELED***" . chr(10) . chr(13) . " Details - " . chr(10) . chr(13) 
		  . "Dispatch ID: " . $row['DispatchID'] . chr(10) . chr(13)
		  . "Scheduled: " . date("m-d-y h:i", strtotime($row['Scheduled'])) 
		  . "Customer: " . $row['CustomerName'] . chr(10) . chr(13) 
		  . "Address: " . $row['Facility'] . chr(10) . chr(13) 
		  . "City: " . $row['City'] . ", " . $row['State'] . chr(10) . chr(13)
		  . "***CANCELED***";
                                       
     	 $strMsg = $strMsg . chr(13) . chr(10) . chr(13) . chr(10) . DISCLAIMER;

 		  return ("mailto:" . $strBCC . "?Subject=" . rawurlencode($strSubj) . "&body=" . rawurlencode($strMsg));	
		}
	else
		;//	echo "no rows";
}
	
?>