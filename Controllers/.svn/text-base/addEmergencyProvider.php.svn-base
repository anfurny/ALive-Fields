<?php
/**
 * This file is a controller that adds a new interpreter in an emergency.
 *
 * This file is a controller that adds a new interpreter in an emergency. An entry is made in
 * the Qualification table and the Interpreter table, and these two are linked. A message is
 * sent to processing, telling them what has happened. An InterpLanguage record is added. The
 * return value is a JSON object consisting of an Interpreter ID and a status string.
 * @copyright Copyright (c) 2008-2011, Language People, Inc.; All rights reserved.
 * @package Dispatch
 * @author Kenneth F. Greenberg
 * 
 */
/**
 * Extract a data item and store it in a global for later use. Input is an array.
 */
error_reporting(E_ERROR | E_USER_ERROR);

$request = json_decode($_REQUEST['request'],true);
$requests = array();
foreach ($request as $item) {
	$requests[$item['name']] = $item['value'];
}
require_once('../../Connections/SQLserver.php');
$status = "success";	// assume the best
$language = $requests['language'];
$service = $requests['service'];
// Do interpreter first so we can have a link
require_once("../../Classes/interpreter.php");
$iRecord = array();
$iRecord['FirstName'] = $requests['firstName'];
$iRecord['LastName'] = $requests['lastName'];
$iRecord['Email'] = $requests['email'];
$iRecord['Address'] = $requests['address'];
$iRecord['City'] = $requests['city'];
$iRecord['State'] = $requests['state'];
$iRecord['ZIP'] = $requests['zipcode'];
$iRecord['HomePhone'] = $requests['phone'];	// is it? or cell?
$iRecord['Active'] = 'True';	// required, or else this fails to insert
$iRecord['Reviewed'] = 'False';	// required, or else this fails to insert
$iObj = new Interpreter;
$interpID = $iObj->create($iRecord);
if (empty($interpID)) {
	$status = "Interpreter insert failed";
} else {
	// Add an InterpLanguage record here
	require_once("../../Classes/InterpLanguage.php");
	$ilRecord = array();
	$ilRecord['InterpID'] = $interpID;
	$ilRecord['Language'] = $language;
	$ilRecord['Interp'] = 'True';	// one hopes this is a valid assumption
	$ilObj = new InterpLanguage;
	$ilObj->create($ilRecord);
	// Add interpreter situation record(s)
	// Add provider service record(s)
	// Add the qual record
	require_once("../../Classes/Qualification.php");
	$qRecord = array();
	$qRecord['InterpID'] = $interpID;
	$qRecord['First Name'] = $requests['firstName'];
	$qRecord['Last Name'] = $requests['lastName'];
	$qRecord['E-mail'] = $requests['email'];
	$qRecord['Address 1'] = $requests['address'];
	$qRecord['City'] = $requests['city'];
	$qRecord['State'] = $requests['state'];
	$qRecord['ZIP'] = $requests['zipcode'];
	$qRecord['Phone'] = $requests['phone'];
	$qObj = new Qualification;
	$qualID = $qObj->create($qRecord);
	if (empty($qualID)) {
		$status = "Candidate insert failed";
	} else {
		// Add a LanguageExperience record
		require_once("../../Classes/LanguageExperience.php");
		$leRecord = array();
		$leRecord['QualID'] = $qualID;
		$leRecord['Language'] = $language;
		$leObj = new LanguageExperience;
		$leObj->create($leRecord);
		// Add QualServiceJoin record(s)
	}
}
// Send an email to processing here
require_once('../../Scripts/geekMail-1.0.php');
$msg = <<<EOT
	PLEASE NOTE EMERGENCY INTERPRETER ASSIGNMENT:
	
	A dispatch required the addition of a new interpreter/service provider to the
	system. As much information as possible has been added, but follow-up will be
	required immediately to make sure we have financial (W-2, SSN) information on
	this person. We also need to start processing this person to see that minimum
	requirementas are met. Please review and update qualification and interpreter
	records.
	
	Interpreter ID: $interpID
	Qualification ID: $qualID
EOT;
$geekMail = new geekMail();
$geekMail->setMailType('text');
$geekMail->from('server@languagepeople.com', 'Language People Server');
$geekMail->to("processing@languagepeople.com");
$geekMail->subject('Dispatch Emergency Interpreter Entry');
$geekMail->message($message);
if ($_SERVER['SERVER_NAME'] == 'portal.languagepeople.com' &&
 strpos(dirname(__FILE__),'training') === FALSE) {
	$geekMail->send();
}
// Return a JSON object with InterpID and status
echo '{"interpid":"'.$interpID.'","status":"'.$status.'"}';
?>