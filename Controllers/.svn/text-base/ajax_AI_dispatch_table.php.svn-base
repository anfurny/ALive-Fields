<?PHP 

require_once( "../includes/alex_functions.php"); 
require_once("../includes/dispatch_functions.php");
 	validate_logged_in();
include "ajax_table.php";
error_reporting(E_ERROR | E_PARSE);
set_error_handler (xml_error, E_ERROR | E_PARSE);
set_time_limit(10);


$var = json_decode($_GET['request']);
$filters = json_decode($_GET['filters']);
$filter_code = filters_to_sql($filters);

//"Day, Scheduled, Customer, City, St., Language, Facility Addr., Special Instructions, Location Specifics, Facility Name, Situation, Client Name, SchedEnd";

//datename 

$sql = "SELECT  DATENAME(DW, Dispatch.Scheduled), Convert(varchar(100), Dispatch.Scheduled, 100), "
. " Customer.CustomerName,Facility.City AS City, Facility.State as State,  Client.Language, "
. " CAST([Facility].[Address] AS VARCHAR) + ', ' + CAST([Facility].[City] AS VARCHAR) + ', ' + CAST([Facility].[State]  AS VARCHAR) + ' ' + CAST([Facility].[Zip] AS VARCHAR) AS FacilityAdd," 

. " Dispatch.SpecialInstruction,Dispatch.Location as Location, Facility.Name as Name, Situation.Description,". " [clientfname] + ' ' + [clientlname] AS [Client Name],   Convert(varchar(100), Dispatch.SchedEnd, 100), Dispatch.DispatchID, Client.ClientID,"
. " Customer.CustID, Dispatch.SituID, Dispatch.Scheduled FROM  "
. " (((Dispatch INNER JOIN Client ON Dispatch.ClientID = Client.ClientID) "

. " INNER JOIN Customer ON Client.CustID = Customer.CustID) LEFT JOIN Situation ON Dispatch.SituID = Situation.SituID)" 

. " INNER JOIN Facility ON Dispatch.FacilityID = Facility.FacilityID " 
. " WHERE (((Dispatch.InterpID) Is Null) AND ((Dispatch.CustCanceled) Is Null) AND ((Dispatch.FacilityID) Is Not Null))" 
. " AND [Client].[Language] not in ('Z demo asl', 'Z new installs test', 'Z zlptestsz', 'Demo and support')  AND Dispatch.ServiceID = 1 " 


. " UNION SELECT DATENAME(DW, Dispatch.Scheduled), Convert(varchar(100), Dispatch.Scheduled, 100) , " 
. " Customer.CustomerName, ZIPCodes.CityName AS City, ZipCodes.StateAbbr as State, Client.Language," 
. "  Dispatch.Location as FacilityAdd, "
. "  Dispatch.SpecialInstruction,   '' as Location,'*OFF SITE*' as Name,  Situation.Description, " 

. " [clientfname] + ' ' + [clientlname] AS [Client Name],  Convert(varchar(100), Dispatch.SchedEnd, 100), Dispatch.DispatchID, Client.ClientID, "

. "  Customer.CustID, Dispatch.SituID, Dispatch.Scheduled FROM ZIPCodes" 

. " INNER JOIN (((Dispatch INNER JOIN Client ON Dispatch.ClientID = Client.ClientID) INNER JOIN Customer ON Client.CustID = Customer.CustID) "

. " LEFT JOIN Situation ON Dispatch.SituID = Situation.SituID) ON (ZIPCodes.Longitude = Dispatch.Longitude) AND (ZIPCodes.Latitude = Dispatch.Latitude) "

. " WHERE (((Dispatch.InterpID) Is Null) AND ((Dispatch.CustCanceled) Is Null) AND ((Dispatch.FacilityID) Is Null)) "
. " AND [Client].[Language] not in ('Z demo asl', 'Z new installs test', 'Z zlptestsz', 'Demo and support')  AND Dispatch.ServiceID = 1 " 
. " ORDER BY Dispatch.Scheduled";

 //$DEBUG = true; 
header('Content-Type: text/html; charset=iso-8859-1');
if (! $DEBUG)
	; //xmlHeader();
else
	echo " a";

echo query_to_json($sql);


?>